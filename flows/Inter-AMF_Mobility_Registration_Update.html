<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>5GC 信令流程图 - 可调布局 (支持缩放/平移)</title>
  <style>
    /* ===== 基础布局 ===== */
    html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}
    #container{display:flex;height:100vh;overflow:hidden;}

    /* ===== 左侧信令图容器 =====
       修复：去掉原先的 cursor:grab; 以免在左侧空白区域出现“小手掌”指针 */
    #diagram-container{flex:1;position:relative;overflow:hidden;}

    #header-names{position:absolute;top:0;left:0;right:0;height:50px;background:#fff;border-bottom:1px solid #eee;overflow:hidden;pointer-events:none;}
    #header-names-inner{position:absolute;top:0;left:0;height:100%;}
    #header-names-inner .node-name{position:absolute;top:50%;transform:translate(-50%,-50%);font-size:14px;color:#333;}
    #diagram-body{position:absolute;top:50px;bottom:0;left:0;right:0;overflow:auto;}
    #diagram{display:block;}

    /* ===== 垂直分隔条 ===== */
    #vertical-divider{width:5px;background:#ddd;cursor:col-resize;user-select:none;}

    /* ===== 右侧面板 ===== */
    #viewer-wrapper{width:400px;display:flex;flex-direction:column;overflow:hidden;}
    #viewer-header{flex:none;padding:10px 12px;background:#f5f5f5;border-bottom:1px solid #ccc;font-weight:bold;}

    /* ===== 右侧上下分区父容器 ===== */
    #right-detail{position:relative;flex:1;min-height:0;}

    /* ===== 右侧上下内容区 ===== */
    #json-viewer {
      position:absolute;left:0;right:0;
      padding:10px;font-size:14px;line-height:1.4;
      overflow-y:auto;box-sizing:border-box;
    }
    #comment-viewer {
      position:absolute;left:0;right:0;
      padding:10px;font-size:14px;line-height:1.4;
      overflow-y:auto;box-sizing:border-box;
    }
    #json-viewer details{margin-left:12px;margin-bottom:4px;}
    #json-viewer summary{cursor:pointer;}

    /* ===== 水平分隔条 ===== */
    #horizontal-divider{
      position:absolute;left:0;right:0;height:5px;background:#ddd;
      cursor:row-resize;user-select:none;
    }

    /* ===== 信令文字标签 ===== */
    .message-label{cursor:default;}
    .message-label:hover{fill:#007ACC;}

    #comment-content {
      max-width: 800px;
      margin: 0 auto;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    #comment-content code {
      font-family: Consolas,"Courier New",monospace;
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
    }
    #comment-content pre code {
      background-color: transparent;
      padding: 0;
    }
    #comment-content pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
    #comment-content ul, #comment-content ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }
    #comment-content li {
      margin: 0.2em 0;
    }
    #comment-viewer::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    #comment-viewer::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    #comment-viewer::-webkit-scrollbar-track {
      background-color: #f5f5f5;
    }
  </style>

  <style id="addon-style">
    .message-label.selected{fill:#ff5722;font-weight:bold;}
  </style>
</head>
<body>
  <div id="container">
    <!-- 左侧信令图 -->
    <div id="diagram-container">
      <div id="header-names"><div id="header-names-inner"></div></div>
      <div id="diagram-body"><svg id="diagram"></svg></div>
    </div>

    <!-- 垂直分隔条 -->
    <div id="vertical-divider"></div>

    <!-- 右侧消息详情 -->
    <div id="viewer-wrapper">
      <div id="viewer-header">消息详情</div>
      <div id="right-detail">
        <div id="json-viewer">请点击左侧消息查看详情</div>
        <div id="horizontal-divider"></div>
        <div id="comment-viewer">
           <div id="comment-content">请点击左侧消息查看注释</div>
         </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/16.1.1/lib/marked.umd.min.js"></script>
  <script>
      document.addEventListener('DOMContentLoaded', () => {
      /* ====== 数据 ====== */
const nodes = ["UE","gNB","AMF (old)","AMF (new)","NRF","AUSF","UDM","UDR","NSSF","PCF","SMF","EIR"]; const messages = [ {from: "UE", to: "gNB", label: "1 RRCConnectionRequest", info: { header: {msg: "RRCConnectionRequest", protocol: "RRC"}, payload: { "ueIdentity [Mandatory]": {randomValue: "0xABCDEF"}, "establishmentCause [Mandatory]": "mo-Signalling" } }, comment: "TS 38.331 §5.3.3 V18.0.0: UE initiates RRC connection establishment to begin the Mobility Registration Update procedure.\n- **ueIdentity** [Mandatory]: Initial UE identity for contention resolution (here a random value is used).\n- **establishmentCause** [Mandatory]: Indicates the reason for RRC connection setup. *mo-Signalling* is used for a mobile-originated signaling request (to send NAS signalling for the registration update)."}, {from: "gNB", to: "UE", label: "2 RRCSetup", info: { header: {msg: "RRCSetup", protocol: "RRC"}, payload: { "rrcTransactionIdentifier [Mandatory]": 0, "radioBearerConfig [Mandatory]": { "srb_ToAddModList [Optional]": [ {"srb_Identity [Mandatory]": 1} ] }, "masterCellGroup [Mandatory]": { "cellGroupId [Mandatory]": 0, "rlc_BearerToAddModList [Optional]": [], "mac_CellGroupConfig [Optional]": {}, "physicalCellGroupConfig [Optional]": {} } } }, comment: "TS 38.331 §5.3.3 V18.0.0: gNB sends RRC Setup to establish the RRC connection, configuring SRB1 for signaling and initial radio parameters.\n- **rrcTransactionIdentifier** [Mandatory]: Transaction identifier for this RRC procedure (set to 0 for initial setup).\n- **radioBearerConfig** [Mandatory]: Configuration of radio bearers for the connection, here establishing SRB1 for control signaling.\n - **srb_ToAddModList** [Optional]: Contains the SRB to set up (SRB1 with identity 1).\n- **masterCellGroup** [Mandatory]: Master cell group configuration for the UE. (Empty optional subfields indicate default configurations for RLC, MAC, physical layers.)"}, {from: "UE", to: "gNB", label: "3 RRCSetupComplete", info: { header: {msg: "RRCSetupComplete", protocol: "RRC"}, payload: { "rrcTransactionIdentifier [Mandatory]": 0, "selectedPLMN_Identity [Mandatory]": "001/01", "dedicatedNAS_Message [Optional]": { "messageType": "RegistrationRequest", "registrationType": "Mobility Registration Update", "nasKeySetIdentifier": {tsc: "native", value: 0}, "fiveGMMCapability": "0xE0", "ueSecurityCapability": { nrEncryptionAlgorithms: ["NEA0","NEA1","NEA2"], nrIntegrityAlgorithms: ["NIA1","NIA2","NIA3"], eutraEncryptionAlgorithms: ["EEA0","EEA1","EEA2"], eutraIntegrityAlgorithms: ["EIA1","EIA2"] }, "fiveGSMobileIdentity": { type: "5G-GUTI", plmnId: "001/01", amfRegionId: 1, amfSetId: 1, amfPointer: 2, tmsi: "0x11111111" }, "lastVisitedRegisteredTAI": {plmnId: "001/01", tac: "000A"}, "pduSessionStatus": [10], "pduSessionsToBeActivated": [10], "requestedNSSAI": [{sst: 1, sd: "010203"}] } } }, comment: "TS 24.501 §8.2.6.1 V18.0.0: UE completes RRC setup and sends a NAS *Registration Request* (Mobility Update type) to the core network. This NAS message includes the UE’s identities and context information.\n- **registrationType** [Mandatory]: *Mobility Registration Update*, indicating the UE is updating its registration due to mobility (new tracking area).\n- **nasKeySetIdentifier** [Mandatory]: Identifier of the current NAS security context (TSC “native”, value 0).\n- **fiveGMMCapability** [Optional]: UE’s 5G MM capabilities (0xE0) for features like DRX, etc.\n- **ueSecurityCapability** [Mandatory]: UE-supported NAS ciphering and integrity algorithms for NR and E-UTRA.\n- **fiveGSMobileIdentity** [Mandatory]: The UE’s 5G-GUTI from the previous registration (PLMN 001/01, AMF region 1/set 1/pointer 2, TMSI 0x11111111) identifying the UE to the new AMF.\n- **lastVisitedRegisteredTAI** [Optional]: The Tracking Area (PLMN 001/01, TAC 000A) of the UE’s last registration, provided to help the new AMF determine the UE’s previous location.\n- **pduSessionStatus** [Optional]: Indicates the UE has an active PDU Session (ID 10) from the previous registration.\n- **pduSessionsToBeActivated** [Optional]: Lists PDU Session ID 10 for which the UE has uplink data pending (requesting activation of user plane for this session).\n- **requestedNSSAI** [Optional]: The S-NSSAI the UE wishes to use (single slice with SST 1, SD 010203)."}, {from: "gNB", to: "AMF (new)", label: "4 InitialUEMessage", info: { header: {msg: "InitialUEMessage", protocol: "NGAP"}, payload: { "ranUeNgapId [Mandatory]": 1, "nasPdu [Mandatory]": { "messageType": "RegistrationRequest", "registrationType": "Mobility Registration Update", "nasKeySetIdentifier": {tsc: "native", value: 0}, "fiveGMMCapability": "0xE0", "ueSecurityCapability": { nrEncryptionAlgorithms: ["NEA0","NEA1","NEA2"], nrIntegrityAlgorithms: ["NIA1","NIA2","NIA3"], eutraEncryptionAlgorithms: ["EEA0","EEA1","EEA2"], eutraIntegrityAlgorithms: ["EIA1","EIA2"] }, "fiveGSMobileIdentity": { type: "5G-GUTI", plmnId: "001/01", amfRegionId: 1, amfSetId: 1, amfPointer: 2, tmsi: "0x11111111" }, "lastVisitedRegisteredTAI": {plmnId: "001/01", tac: "000A"}, "pduSessionStatus": [10], "pduSessionsToBeActivated": [10], "requestedNSSAI": [{sst: 1, sd: "010203"}] }, "establishmentCause [Mandatory]": "mo-Signalling", "ueContextRequest [Optional]": true } }, comment: "TS 38.413 §8.6.1.2 V18.0.0: gNB forwards the NAS request to the new AMF in an *Initial UE Message*. The message includes the NAS Registration Request and indicates that the AMF should retrieve the UE’s context.\n- **ranUeNgapId** [Mandatory]: ID assigned by the gNB to identify the UE over this NGAP interface.\n- **nasPdu** [Mandatory]: Contains the NAS *Registration Request* (as detailed above) for the AMF.\n- **establishmentCause** [Mandatory]: *mo-Signalling*, echoing that the UE initiated RRC for signaling.\n- **ueContextRequest** [Optional]: Set to true to instruct the new AMF to request the UE’s context from the old AMF (since the UE provided a GUTI pointing to a different AMF)."}, {from: "AMF (new)", to: "AMF (old)", label: "5 Namf_Communication_UEContextTransfer Request", info: { http: {method: "POST", uri: "/namf-comm/v1/ue-contexts/transfer"}, body: {supi: "imsi-001010000000001", "oldContextIncluded": true} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: Upon receiving a GUTI indicating a different AMF, the new AMF requests the UE’s context from the old AMF. This service call includes the UE’s permanent ID if known.\n- **supi** [Optional]: The UE’s SUPI (IMSI) as extracted from the GUTI (if available).\n- **oldContextIncluded** [Optional]: Indicates that the complete UE context (including security context, PDU sessions, etc.) is requested from the old AMF."}, {from: "AMF (old)", to: "AMF (new)", label: "6 Namf_Communication_UEContextTransfer Response", info: { status: 200, body: { supi: "imsi-001010000000001", ueContext: { securityContext: "transferred", pduSessions: [{pduSessionId: 10, smfId: "SMF1"}], amPolicyAssociation: {pcfId: "PCF1", triggers: ["LOC_CH"]}, pei: "0123456789012345" } } }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The old AMF returns the UE’s context to the new AMF.\n- **supi** [Mandatory]: The UE’s permanent subscription ID (IMSI) as known by the old AMF.\n- **ueContext** [Mandatory]: The transferred UE context, including stored information such as: security context (to continue NAS security without re-authentication), active PDU session references (here session 10 with its SMF), any AM Policy association (with PCF and triggers like location change), and the UE’s last known PEI (device ID)."}, {from: "AMF (new)", to: "gNB", label: "7 DownlinkNASTransport (IdentityRequest)", info: {}, comment: ""}, {from: "gNB", to: "UE", label: "8 DLInformationTransfer (IdentityRequest)", info: {}, comment: ""}, {from: "UE", to: "gNB", label: "9 ULInformationTransfer (IdentityResponse)", info: {}, comment: ""}, {from: "gNB", to: "AMF (new)", label: "10 UplinkNASTransport (IdentityResponse)", info: {}, comment: ""}, {from: "AMF (new)", to: "NRF", label: "11 Nnrf_NFDiscovery (AUSF)", info: {}, comment: ""}, {from: "NRF", to: "AMF (new)", label: "12 Nnrf_NFDiscovery Response", info: {}, comment: ""}, {from: "AMF (new)", to: "AUSF", label: "13 Nausf_UEAuthentication Request", info: {}, comment: ""}, {from: "AUSF", to: "UDM", label: "14 Nudm_Authentication_Get Request", info: {}, comment: ""}, {from: "UDM", to: "UDR", label: "15 Nudr_DM_Query (AuthData)", info: {}, comment: ""}, {from: "UDR", to: "UDM", label: "16 Nudr_DM_Query Response", info: {}, comment: ""}, {from: "UDM", to: "AUSF", label: "17 Nudm_Authentication_Get Response", info: {}, comment: ""}, {from: "AUSF", to: "AMF (new)", label: "18 Nausf_UEAuthentication Response", info: {}, comment: ""}, {from: "AMF (new)", to: "gNB", label: "19 DownlinkNASTransport (AuthenticationRequest)", info: {}, comment: ""}, {from: "gNB", to: "UE", label: "20 DLInformationTransfer (AuthenticationRequest)", info: {}, comment: ""}, {from: "UE", to: "gNB", label: "21 ULInformationTransfer (AuthenticationResponse)", info: {}, comment: ""}, {from: "gNB", to: "AMF (new)", label: "22 UplinkNASTransport (AuthenticationResponse)", info: {}, comment: ""}, {from: "AMF (new)", to: "AUSF", label: "23 Nausf_UEAuthentication_Confirm Request", info: {}, comment: ""}, {from: "AUSF", to: "AMF (new)", label: "24 Nausf_UEAuthentication_Confirm Response", info: {}, comment: ""}, {from: "AMF (new)", to: "gNB", label: "25 DownlinkNASTransport (SecurityModeCommand)", info: {}, comment: ""}, {from: "gNB", to: "UE", label: "26 DLInformationTransfer (SecurityModeCommand)", info: {}, comment: ""}, {from: "UE", to: "gNB", label: "27 ULInformationTransfer (SecurityModeComplete)", info: {}, comment: ""}, {from: "gNB", to: "AMF (new)", label: "28 UplinkNASTransport (SecurityModeComplete)", info: {}, comment: ""}, {from: "AMF (new)", to: "EIR", label: "29 N5g-eir_EquipmentIdentityCheck Request", info: { http: {method: "POST", uri: "/5g-eir/v1/equipment-status"}, body: {pei: "IMEI:0123456789012345", supi: "imsi-001010000000001"} }, comment: "TS 23.502 §4.7 V18.0.0: The new AMF performs an Equipment Identity Check by querying the EIR with the UE’s device ID.\n- **pei** [Mandatory]: The UE’s Permanent Equipment Identifier (IMEI with SV). Here, 0123456789012345 is the device’s IMEISV transferred from the old AMF.\n- **supi** [Optional]: The UE’s subscription identifier (IMSI), provided for reference. The EIR primarily checks the equipment ID status."}, {from: "EIR", to: "AMF (new)", label: "30 N5g-eir_EquipmentIdentityCheck Response", info: { status: 200, body: {status: "whitelist"} }, comment: "TS 23.502 §4.7 V18.0.0: The EIR responds with the status of the UE’s equipment.\n- **status** [Mandatory]: The result of the IMEI check. *whitelist* indicates the device is allowed (not blacklisted)."}, {from: "AMF (new)", to: "UDM", label: "31 Nudm_UEContextManagement_Registration Request", info: { http: {method: "PUT", uri: "/nudm-uecm/v1/{ueId}/registrations/amf-3gpp-access"}, body: { amfInstanceId: "AMF2", guami: {plmnId: "00101", amfId: "123456"}, deregCallbackUri: "https://amf2.example.com/namf-comm/v1/{ueId}/dereg-notify" } }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The new AMF registers the UE’s context with the UDM (for 3GPP access).\n- **amfInstanceId** [Mandatory]: Identifier of the new serving AMF instance (\"AMF2\").\n- **guami** [Mandatory]: The Globally Unique AMF Identifier of the new AMF (PLMN 00101 and AMF ID 123456).\n- **deregCallbackUri** [Mandatory]: Callback URI that UDM will invoke to notify the old AMF of deregistration (the new AMF’s endpoint for deregistration notifications)."}, {from: "UDM", to: "UDR", label: "32 Nudr_DM_Update (AMF3GPPAccess)", info: { http: {method: "PUT", uri: "/nudr-dr/v1/subscription-data/{supi}/ue-context"}, body: {servingAmf: "AMF2", accessType: "3GPP"} }, comment: "TS 23.502 §4.4.4.3 V18.0.0: The UDM updates the subscriber data in the UDR to reflect the new serving AMF.\n- **servingAmf** [Mandatory]: The new AMF’s identity (\"AMF2\") now serving the UE.\n- **accessType** [Mandatory]: The access type for this registration (\"3GPP\" for NR access)."}, {from: "UDR", to: "UDM", label: "33 Nudr_DM_Update Response", info: { status: 204 }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDR confirms the update of the UE’s AMF registration information (HTTP 204 No Content indicates success)."}, {from: "UDM", to: "AMF (new)", label: "34 Nudm_UEContextManagement_Registration Response", info: { status: 204 }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: UDM acknowledges the new AMF registration (no content, success). The UDM will trigger deregistration notification toward the old AMF as a result of this update."}, {from: "AMF (new)", to: "UDM", label: "35 Nudm_SubscriberDataManagement_Get Request", info: { http: {method: "GET", uri: "/nudm-sdm/v1/{supi}/subscription-data?dataset=AMData,SMFSelectData"} }, comment: "TS 23.502 §4.4.4.3 V18.0.0: The new AMF requests the UE’s subscription data from the UDM, including Access & Mobility data and SMF selection data.\n- **dataset**: Specifies which data sets to retrieve (here AMData for allowed NSSAI, and SMFSelectData for default SMF selection info)."}, {from: "UDM", to: "UDR", label: "36 Nudr_DM_Query (SubscriptionData)", info: { http: {method: "GET", uri: "/nudr-dr/v1/subscription-data/{supi}/subscription-information"} }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDM queries the UDR for the subscriber’s access and session management subscription data (allowed slices, default DNN, etc.)."}, {from: "UDR", to: "UDM", label: "37 Nudr_DM_Query Response", info: { status: 200, body: { amData: {allowedNSSAI: [{sst: 1, sd: "010203"}]}, smfSelData: {defaultSingleNssai: {sst: 1, sd: "010203"}, defaultDnn: "internet"} } }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDR returns the subscription data.\n- **amData** [Optional]: Access-Mobility subscription data (e.g., Allowed NSSAI). The allowed slice list includes SST 1, SD 010203, matching the UE’s requested slice.\n- **smfSelData** [Optional]: SMF Selection data (e.g., default slice and default DNN for the UE). Here, default slice SST 1/SD 010203 and default DNN ‘internet’ are provided."}, {from: "UDM", to: "AMF (new)", label: "38 Nudm_SubscriberDataManagement_Get Response", info: { status: 200, body: { allowedNSSAI: [{sst: 1, sd: "010203"}], defaultDNN: "internet", smsSubscribed: true, smsfId: null } }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDM responds with the requested subscription data.\n- **allowedNSSAI** [Optional]: Allowed NSSAI for the UE (slice SST 1, SD 010203 is permitted).\n- **defaultDNN** [Optional]: The default Data Network Name for the UE’s subscription (\"internet\").\n- **smsSubscribed** [Optional]: Indicates the UE is subscribed to SMS-over-NAS services (true).\n- **smsfId** [Optional]: Identifier of the SMSF assigned (if any; null means no SMSF currently serving the UE)."}, {from: "AMF (new)", to: "UDM", label: "39 Nudm_SubscriberDataManagement_Subscribe Request", info: { http: {method: "POST", uri: "/nudm-sdm/v1/{supi}/subscription-data/subscription"}, body: {dataset: "AMData,SMFSelectData"} }, comment: "TS 23.502 §4.4.4.3 V18.0.0: The new AMF subscribes to changes in the UE’s subscription data.\n- **dataset**: Specifies the data sets for which the AMF requests change notifications (AMData and SMFSelectData in this case)."}, {from: "UDM", to: "UDR", label: "40 Nudr_DM_Subscribe (SubscriptionData)", info: { http: {method: "POST", uri: "/nudr-dr/v1/subscription-data/{supi}/subscription-data-subscribe"} }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDM relays the subscription request to the UDR, to be notified of changes in the subscriber’s data."}, {from: "UDR", to: "UDM", label: "41 Nudr_DM_Subscribe Response", info: { status: 204 }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDR confirms the subscription for data change notifications (204 No Content)."}, {from: "UDM", to: "AMF (new)", label: "42 Nudm_SubscriberDataManagement_Subscribe Response", info: { status: 204 }, comment: "TS 23.502 §4.4.4.3 V18.0.0: UDM confirms the AMF’s subscription to the data changes (successful, no content)."}, {from: "AMF (new)", to: "NSSF", label: "43 Nnssf_NSSelection_Get Request", info: { http: {method: "GET", uri: "/nnssf-nsselection/v1/network-slice-information?homeSnssai={sst:1,sd:'010203'}&tai=001-01-000B"} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The new AMF queries the NSSF for network slice information given the UE’s subscribed slice and new location.\n- **homeSnssai** [Optional]: The S-NSSAI from the UE’s home network subscription (SST 1, SD 010203) that the UE is requesting.\n- **tai** [Mandatory]: The Tracking Area Identifier of the UE’s current location (PLMN 001-01, TAC 000B). The NSSF uses this to determine allowed slices in the new area."}, {from: "NSSF", to: "AMF (new)", label: "44 Nnssf_NSSelection_Get Response", info: { status: 200, body: {allowedNssai: [{sst: 1, sd: "010203"}], targetAmfSet: "AMF_SET_1"} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: NSSF returns the allowed slices and possibly target AMF guidance.\n- **allowedNssai** [Mandatory]: The list of allowed S-NSSAIs for the UE in the new tracking area (here SST 1, SD 010203 is allowed, same as the UE’s request).\n- **targetAmfSet** [Optional]: Suggestion for AMF set that can serve the requested slice (here AMF_SET_1, indicating the UE’s slice is served by AMFs in set 1). (No change of AMF needed as the UE is already on an AMF of that set.)"}, {from: "AMF (new)", to: "PCF", label: "45 Npcf_AMPolicyControl_Create Request", info: { http: {method: "POST", uri: "/npcf-am-policy-control/v1/policies"}, body: {supi: "imsi-001010000000001", accessType: "3GPP", allowedNssai: [{sst: 1, sd: "010203"}]} }, comment: "TS 23.502 §4.4.1 V18.0.0: The new AMF establishes an Access and Mobility Policy association with the PCF for this UE.\n- **supi** [Mandatory]: The subscriber’s identifier (IMSI).\n- **accessType** [Mandatory]: Access type for this policy (\"3GPP\" for NR access).\n- **allowedNssai** [Optional]: The allowed slice list for the UE (SST 1, SD 010203), provided to the PCF for policy decisions."}, {from: "PCF", to: "AMF (new)", label: "46 Npcf_AMPolicyControl_Create Response", info: { status: 201, body: { policyAssociationId: "PA-002", amPolicy: { policyControlReqTriggers: ["LOC_CH"], policyConstraints: {} } } }, comment: "TS 23.502 §4.4.1 V18.0.0: PCF confirms creation of the AM policy association and returns a Policy Association ID.\n- **policyAssociationId** [Mandatory]: Identifier for this policy association (e.g., “PA-002”).\n- **amPolicy** [Optional]: Policy details and triggers.\n - **policyControlReqTriggers** [Optional]: Events that should trigger reports from AMF to PCF (here *LOC_CH* for location change, which has already occurred).\n - **policyConstraints** [Optional]: Any constraints on the policy (none specified here)."}, {from: "AMF (new)", to: "gNB", label: "47 InitialContextSetupRequest", info: { header: {msg: "InitialContextSetupRequest", protocol: "NGAP"}, payload: { "nasPdu": { "messageType": "RegistrationAccept", "guti": {plmnId: "001/01", amfRegionId: 1, amfSetId: 1, amfPointer: 3, tmsi: "0x22222222"}, "taiList": [{plmnId: "001/01", tac: "000B"}], "allowedNSSAI": [{sst: 1, sd: "010203"}], "smsAllowed": true } } }, comment: "TS 38.413 §8.6.3 V18.0.0: The new AMF sends an *Initial Context Setup Request* to the gNB, including the NAS *Registration Accept* for the UE. This establishes the UE’s context in the RAN.\n- **nasPdu**: Contains the NAS *Registration Accept* message.\n - **guti** [Optional]: The new 5G-GUTI assigned to the UE (PLMN 001/01, AMF region 1/set 1, pointer 3, TMSI 0x22222222). The UE will use this GUTI for future interactions.\n - **taiList** [Mandatory]: The list of TAIs for the UE’s new Registration Area (here TAC 000B in PLMN 001/01).\n - **allowedNSSAI** [Mandatory]: The Allowed NSSAI in this area (slice SST 1, SD 010203).\n - **smsAllowed** [Mandatory]: Indicates SMS-over-NAS is permitted for the UE (true)."}, {from: "gNB", to: "UE", label: "48 RRCSecurityModeCommand", info: { header: {msg: "RRCSecurityModeCommand", protocol: "RRC"}, payload: { securityAlgorithmConfig: {ciphering: "NEA2", integrity: "NIA2"} } }, comment: "TS 38.331 §8.2.3 V18.0.0: The gNB initiates RRC security activation for the Access-Stratum.\n- **securityAlgorithmConfig** [Mandatory]: Algorithms for RRC and UP encryption/integrity. Ciphering is set to *NEA2* and integrity to *NIA2* (as determined by the network’s policy and UE capabilities)."}, {from: "UE", to: "gNB", label: "49 RRCSecurityModeComplete", info: { header: {msg: "RRCSecurityModeComplete", protocol: "RRC"}, payload: {} }, comment: "TS 38.331 §8.2.3 V18.0.0: UE confirms the activation of RRC security (no additional payload; it’s an acknowledgment message)."}, {from: "gNB", to: "UE", label: "50 DLInformationTransfer (RegistrationAccept)", info: { header: {msg: "DLInformationTransfer", protocol: "RRC"}, payload: { "dedicatedNAS_Message": { "messageType": "RegistrationAccept", "guti": {plmnId: "001/01", amfRegionId: 1, amfSetId: 1, amfPointer: 3, tmsi: "0x22222222"}, "taiList": [{plmnId: "001/01", tac: "000B"}], "allowedNSSAI": [{sst: 1, sd: "010203"}], "smsAllowed": true } } }, comment: "TS 38.331 §5.7.2 V18.0.0: The gNB delivers the NAS *Registration Accept* to the UE in a dedicated RRC message.\n- **RegistrationAccept** (NAS): Confirms the UE’s registration update.\n - **guti**: The new 5G-GUTI assigned by the AMF (as above).\n - **taiList**: The new tracking area list where the UE is registered (TAC 000B in PLMN 001/01).\n - **allowedNSSAI**: The allowed slice list in this area (SST 1, SD 010203).\n - **smsAllowed**: Indicates the UE may use NAS for SMS (allowed)."}, {from: "UE", to: "gNB", label: "51 ULInformationTransfer (RegistrationComplete)", info: { header: {msg: "ULInformationTransfer", protocol: "RRC"}, payload: { dedicatedNAS_Message: {messageType: "RegistrationComplete"} } }, comment: "TS 24.501 §8.2.7.3 V18.0.0: The UE sends a *Registration Complete* NAS message, acknowledging receipt of the Registration Accept and indicating that the registration update procedure is finished on the UE side.\n- **messageType** [Mandatory]: *Registration Complete*. (No additional IEs; it serves as a confirmation.)"}, {from: "gNB", to: "AMF (new)", label: "52 UplinkNASTransport (RegistrationComplete)", info: { header: {msg: "UplinkNASTransport", protocol: "NGAP"}, payload: { nasPdu: {messageType: "RegistrationComplete"} } }, comment: "TS 38.413 §8.6.3 V18.0.0: The gNB forwards the UE’s *Registration Complete* message to the new AMF. This informs the AMF that the UE has successfully received the Registration Accept and that the NAS procedure is complete."}, {from: "gNB", to: "AMF (new)", label: "53 InitialContextSetupResponse", info: { header: {msg: "InitialContextSetupResponse", protocol: "NGAP"}, payload: {} }, comment: "TS 38.413 §8.6.4 V18.0.0: The gNB confirms successful setup of the UE’s context to the AMF. *(No payload; this acknowledgment indicates that the gNB has established the context, including RRC security and NAS delivery.)*"}, {from: "AMF (new)", to: "AMF (old)", label: "54 Namf_Communication_RegistrationCompleteNotify", info: { http: {method: "POST", uri: "/namf-comm/v1/ue-contexts/registration-complete"}, body: {} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The new AMF notifies the old AMF that the UE’s registration with the new AMF is complete. This prompts the old AMF to release resources related to the UE. (If any PDU sessions were no longer supported in the new area, their IDs and causes would be included in this notification.)"}, {from: "UDM", to: "AMF (old)", label: "55 Nudm_UECM_DeregistrationNotification", info: { http: {method: "POST", uri: "https://old-amf.example.com/namf-comm/v1/{ueId}/dereg-notify"}, body: {reason: "new-registration"} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: UDM informs the old AMF that the UE has registered with a new AMF (deregistration notification for 3GPP access).\n- **reason** [Mandatory]: Indicates why the deregistration is happening (\"new-registration\" at another AMF). The old AMF now knows the UE is served by a new AMF and should release its context."}, {from: "AMF (old)", to: "SMF", label: "56 Nsmf_PDUSession_ReleaseSMContext Request", info: { http: {method: "POST", uri: "/nsmf-pdusession/v1/sm-contexts/{smContextId}/release"}, body: {pduSessionId: 10, cause: "Deregistration"} }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The old AMF requests each SMF to release the UE’s PDU session context, since the UE is no longer served by this AMF.\n- **pduSessionId** [Mandatory]: The PDU Session ID (10) that was active on the old AMF.\n- **cause** [Mandatory]: Reason for release (the UE has deregistered from the old AMF)."}, {from: "SMF", to: "AMF (old)", label: "57 Nsmf_PDUSession_ReleaseSMContext Response", info: { status: 204 }, comment: "TS 23.502 §4.2.2.2.2 V18.0.0: The SMF acknowledges the release of the PDU session context associated with the old AMF (HTTP 204 indicates successful release)."}, {from: "AMF (new)", to: "SMF", label: "58 Nsmf_PDUSession_UpdateSMContext Request", info: { http: {method: "PUT", uri: "/nsmf-pdusession/v1/sm-contexts/{smContextId}"}, body: {pduSessionId: 10, requestType: "HO", anType: "3GPP"} }, comment: "TS 23.502 §4.3.2.2.2 V18.0.0: The new AMF informs the SMF that the UE is now reachable via a new gNB (after mobility). This updates the PDU Session’s control plane context.\n- **pduSessionId** [Mandatory]: The PDU Session ID (10) to update.\n- **requestType** [Mandatory]: *HO* (Handover/relocation), indicating this update is due to mobility.\n- **anType** [Mandatory]: Access network type (\"3GPP\" for NR) for the updated connection."}, {from: "SMF", to: "AMF (new)", label: "59 Nsmf_PDUSession_UpdateSMContext Response", info: { status: 200, body: {n2SmInfo: {dlTunnelInfo: {teid: "0xABCDEF01", transportLayerAddr: "198.51.100.1"}}} }, comment: "TS 23.502 §4.3.2.2.2 V18.0.0: The SMF confirms the update and provides N2 signaling information for user-plane setup.\n- **n2SmInfo** [Optional]: Core network tunnel info for this PDU session. Contains the *downlink* GTP-U tunnel endpoint information that the gNB should use (UPF IP address 198.51.100.1 and TEID 0xABCDEF01 for downlink)."}, {from: "AMF (new)", to: "gNB", label: "60 PDU Session Resource Setup Request", info: { header: {msg: "PDU Session Resource Setup Request", protocol: "NGAP"}, payload: { "pduSessionResourceSetupList [Mandatory]": [{ "pduSessionId [Mandatory]": 10, "pduSessionNAS-PDU [Optional]": null, "pduSessionResourceSetupRequestTransfer [Mandatory]": { "UL NG-U UP TNL Information [Mandatory]": { transportLayerAddress: "198.51.100.1", gtpTunnelEndpointId: "0xABCDEF01" } } }] } }, comment: "TS 38.413 §9.2.1.2 V18.0.0: The AMF instructs the gNB to set up radio bearers for the active PDU session.\n- **pduSessionResourceSetupList** [Mandatory]: List of PDU sessions to establish user-plane for. Here it contains one entry for PDU Session ID 10.\n - **pduSessionId** [Mandatory]: The ID of the PDU session (10) for which resources are being set up.\n - **pduSessionNAS-PDU** [Optional]: NAS message for the PDU session (not present since the session was already established earlier; this is a resume of user plane).\n - **pduSessionResourceSetupRequestTransfer** [Mandatory]: NGAP transfer IE carrying RAN-specific setup info.\n - **UL NG-U UP TNL Information** [Mandatory]: The User Plane Tunnel info for Uplink direction provided to gNB (the UPF’s address and TEID for this session’s downlink; gNB will use this for sending uplink traffic to UPF)."}, {from: "gNB", to: "AMF (new)", label: "61 PDU Session Resource Setup Response", info: { header: {msg: "PDU Session Resource Setup Response", protocol: "NGAP"}, payload: { "pduSessionResourceSetupResponseList [Mandatory]": [{ "pduSessionId [Mandatory]": 10, "pduSessionResourceSetupResponseTransfer [Mandatory]": { "UL NG-U UP TNL Information [Mandatory]": { transportLayerAddress: "203.0.113.1", gtpTunnelEndpointId: "0x1234ABCD" } } }] } }, comment: "TS 38.413 §9.2.1.3 V18.0.0: The gNB confirms the PDU session resource setup.\n- **pduSessionResourceSetupResponseList** [Mandatory]: List of PDU sessions successfully set up. Contains one entry for session 10.\n - **pduSessionId** [Mandatory]: ID of the PDU session (10).\n - **pduSessionResourceSetupResponseTransfer** [Mandatory]: RAN->CN transfer IE with the gNB’s tunnel info.\n - **UL NG-U UP TNL Information** [Mandatory]: The gNB’s GTP-U tunnel endpoint info for Uplink (i.e., for the UPF to send downlink packets). This includes gNB’s IP address (203.0.113.1) and TEID (0x1234ABCD) for this session."}, {from: "AMF (new)", to: "SMF", label: "62 Nsmf_PDUSession_UpdateSMContext Request", info: { http: {method: "PUT", uri: "/nsmf-pdusession/v1/sm-contexts/{smContextId}"}, body: {pduSessionId: 10, n2SmInfo: {ulTunnelInfo: {teid: "0x1234ABCD", transportLayerAddr: "203.0.113.1"}}} }, comment: "TS 23.502 §4.3.2.2.2 V18.0.0: The AMF informs the SMF of the gNB’s tunnel parameters after successful resource setup.\n- **pduSessionId** [Mandatory]: The PDU Session ID (10).\n- **n2SmInfo** [Mandatory]: Information from the RAN about the established tunnel. It includes the *uplink* tunnel info provided by gNB (its IP and TEID 0x1234ABCD for downlink data). This allows the SMF to update the UPF with the new downlink tunnel endpoint."}, {from: "SMF", to: "AMF (new)", label: "63 Nsmf_PDUSession_UpdateSMContext Response", info: { status: 204 }, comment: "TS 23.502 §4.3.2.2.2 V18.0.0: SMF confirms it has updated the user-plane context with the gNB’s information (no content, success). The PDU session’s user plane is now fully re-established at the new location."}, {from: "AMF (new)", to: "gNB", label: "64 UEContextReleaseCommand", info: { header: {msg: "UEContextReleaseCommand", protocol: "NGAP"}, payload: {cause: "UE-NormalRelease"} }, comment: "TS 38.413 §8.9.3 V18.0.0: After completion of the update, the AMF (if no further user data is active or after handling pending data) may release the UE’s RAN context.\n- **cause** [Mandatory]: The reason for release. *UE-NormalRelease* indicates a normal release (e.g., the UE is moving to idle mode after completing the update procedure)."}, {from: "gNB", to: "UE", label: "65 RRCRelease", info: { header: {msg: "RRCRelease", protocol: "RRC"}, payload: {releaseCause: "normal"} }, comment: "TS 38.331 §5.3.5 V18.0.0: The gNB releases the RRC connection, moving the UE to RRC idle state.\n- **releaseCause** [Optional]: Indicates the reason for release. “normal” is used here, meaning the connection is being released without error (routine release)."}, {from: "gNB", to: "AMF (new)", label: "66 UEContextReleaseComplete", info: { header: {msg: "UEContextReleaseComplete", protocol: "NGAP"}, payload: {} }, comment: "TS 38.413 §8.9.3 V18.0.0: The gNB confirms to the AMF that it has released the UE’s context. All radio resources for the UE are now freed. *(No payload content.)*"} ]; 
  /* ====== 页面元素 ====== */
      const headerInner=document.getElementById('header-names-inner');
      const bodyDiv=document.getElementById('diagram-body');
      const svg=document.getElementById('diagram');
      const diagramContainer=document.getElementById('diagram-container');
      const verticalDivider=document.getElementById('vertical-divider');
      const viewerWrapper=document.getElementById('viewer-wrapper');

      const rightDetail=document.getElementById('right-detail');
      const jsonViewer=document.getElementById('json-viewer');
      const commentViewer=document.getElementById('comment-viewer');
      const commentContent=document.getElementById('comment-content');
      const hDivider=document.getElementById('horizontal-divider');

      /* ====== 绘制信令图 ====== */
      const headerHeight=50;
      const margin={top:headerHeight,bottom:50,left:100,right:100};
      const xStep=200,msgSpacing=80;
      const totalHeight=margin.top+msgSpacing*(messages.length+1)+margin.bottom;
      const totalWidth=margin.left+xStep*(nodes.length-1)+margin.right;
      svg.setAttribute('width',totalWidth);
      svg.setAttribute('height',totalHeight);
      headerInner.style.width=totalWidth+'px';

      /* X 坐标 */
      const xs={};
      nodes.forEach((n,i)=>{
        const x=margin.left+i*xStep;
        xs[n]=x;
        const d=document.createElement('div');
        d.className='node-name';
        d.textContent=n;
        d.style.left=x+'px';
        headerInner.appendChild(d);
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',x);line.setAttribute('y1',margin.top);
        line.setAttribute('x2',x);line.setAttribute('y2',totalHeight-margin.bottom);
        line.setAttribute('stroke','#aaa');line.setAttribute('stroke-dasharray','4 2');
        svg.appendChild(line);
      });

      /* 箭头 marker */
      const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
      const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
      marker.setAttribute('id','arrow');marker.setAttribute('markerWidth','8');marker.setAttribute('markerHeight','8');
      marker.setAttribute('refX','6');marker.setAttribute('refY','3');marker.setAttribute('orient','auto');
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d','M0,0 L0,6 L6,3 Z');path.setAttribute('fill','#000');
      marker.appendChild(path);defs.appendChild(marker);svg.appendChild(defs);

      /* 渲染消息线条和标签 */
      messages.forEach((m,i)=>{
        const y=margin.top+msgSpacing*(i+1);
        const x1=xs[m.from],x2=xs[m.to];
        const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',x1);ln.setAttribute('y1',y);
        ln.setAttribute('x2',x2);ln.setAttribute('y2',y);
        ln.setAttribute('stroke','#000');ln.setAttribute('marker-end','url(#arrow)');
        svg.appendChild(ln);
        const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
        lbl.setAttribute('x',(x1+x2)/2);lbl.setAttribute('y',y-6);
        lbl.setAttribute('text-anchor','middle');lbl.classList.add('message-label');
        lbl.textContent=m.label;
        lbl.addEventListener('click',()=>{
          renderJSON(m.info,jsonViewer);
          commentContent.innerHTML=marked.parse(m.comment);
        });
        svg.appendChild(lbl);
      });

      /* ====== JSON 渲染函数 ====== */
      function renderJSON(obj,container){
        container.innerHTML='';
        function walk(k,v,parent){
          if(v&&typeof v==='object'){
            const d=document.createElement('details');d.open=true;
            const s=document.createElement('summary');s.textContent=k;d.appendChild(s);
            for(const kk in v)walk(kk,v[kk],d);
            parent.appendChild(d);
          }else{
            const div=document.createElement('div');
            div.textContent=k+': '+v;parent.appendChild(div);
          }
        }
        for(const key in obj)walk(key,obj[key],container);
      }

      
      /* ====== 同步水平滚动，保持节点标题与竖线对齐 ===== */
      bodyDiv.addEventListener('scroll', () => {
        headerInner.style.transform = `translateX(${-bodyDiv.scrollLeft}px)`;
      });
      /* 初始化一次，避免刚加载时错位 */
      headerInner.style.transform = 'translateX(0px)';
      /* ====== 右侧面板拖拽 ===== */
      verticalDivider.addEventListener('mousedown',e=>{
        e.preventDefault();
        const startX=e.clientX,startW=viewerWrapper.offsetWidth;
        function onMove(ev){viewerWrapper.style.width=(startW-(ev.clientX-startX))+'px';}
        function stop(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',stop);}
        document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',stop);
      });

      function initVertical(){const h=rightDetail.clientHeight/2;jsonViewer.style.top='0';jsonViewer.style.height=h+'px';hDivider.style.top=h+'px';commentViewer.style.top=(h+5)+'px';commentViewer.style.height=(h-5)+'px';}
      initVertical();window.addEventListener('resize',initVertical);
      hDivider.addEventListener('mousedown',e=>{
        e.preventDefault();
        const startY=e.clientY,startH=jsonViewer.offsetHeight;
        function onMove(ev){
          const newH=startH+(ev.clientY-startY);
          jsonViewer.style.height=newH+'px';hDivider.style.top=newH+'px';
          commentViewer.style.top=(newH+5)+'px';commentViewer.style.height=(rightDetail.clientHeight-newH-5)+'px';
        }
        function stop(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',stop);}
        document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',stop);
      });

      /* ====== 缩放与平移 ===== */
      const originalW=totalWidth,originalH=totalHeight;let scale=1;
      svg.setAttribute('viewBox',`0 0 ${originalW} ${originalH}`);

      /* 拖拽平移（保持功能，不改变指针样式） */
      let dragging=false,sx=0,sy=0;
      diagramContainer.addEventListener('mousedown',e=>{
        dragging=true;sx=e.clientX;sy=e.clientY;e.preventDefault();});
      document.addEventListener('mousemove',e=>{
        if(!dragging) return;
        diagramContainer.scrollLeft-=e.clientX-sx;
        diagramContainer.scrollTop -=e.clientY-sy;
        sx=e.clientX;sy=e.clientY;
      });
      document.addEventListener('mouseup',()=>{dragging=false;});

      /* 缩放 */
      diagramContainer.addEventListener('wheel',e=>{
        if(!e.ctrlKey)return;
        e.preventDefault();
        const factor=(Math.abs(e.deltaY)<50)?(e.deltaY<0?1.05:0.95):(e.deltaY<0?1.2:0.8);
        const newScale=scale*factor;if(newScale<0.1||newScale>10)return;
        const rect=diagramContainer.getBoundingClientRect();
        const cx=e.clientX-rect.left,cy=e.clientY-rect.top;
        const contentX=(diagramContainer.scrollLeft+cx)/scale;
        const contentY=(diagramContainer.scrollTop+cy)/scale;
        scale=newScale;
        svg.setAttribute('width',originalW*scale);svg.setAttribute('height',originalH*scale);
        headerInner.style.width=(originalW*scale)+'px';
        nodes.forEach((n,i)=>{headerInner.children[i].style.left=((margin.left+i*xStep)*scale)+'px';});
        diagramContainer.scrollLeft=contentX*scale-cx;
        diagramContainer.scrollTop =contentY*scale-cy;
      },{passive:false});
    });
  </script>

  <script id="addon-script">
    document.addEventListener('DOMContentLoaded', function(){
      const labels = Array.from(document.querySelectorAll('.message-label'));
      let currentIdx = -1;
      const select = (idx, viaKey=false) => {
        if(idx < 0 || idx >= labels.length) return;
        if(currentIdx >= 0) labels[currentIdx].classList.remove('selected');
        currentIdx = idx;
        const lbl = labels[currentIdx];
        lbl.classList.add('selected');
        if(viaKey) {
          lbl.scrollIntoView({block:'center', inline:'center'});
        }
        lbl.dispatchEvent(new Event('click'));
      };
      labels.forEach((lbl, idx) => {
        lbl.addEventListener('click', () => {
          if(currentIdx >= 0) labels[currentIdx].classList.remove('selected');
          currentIdx = idx;
          lbl.classList.add('selected');
        });
      });
      document.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowDown'){
          e.preventDefault();
          select(currentIdx + 1, true);
        } else if(e.key === 'ArrowUp'){
          e.preventDefault();
          select(currentIdx - 1, true);
        }
      });
    });
  </script>
</body>
</html>
